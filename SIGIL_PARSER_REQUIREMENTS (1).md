# Sigil Parser Requirements Document

**Source**: nyx-sigil codebase (73 files)
**Generated by**: Claude (AI agent consuming Sigil)
**Refined through**: Collaborative design conversation with Sigil's author
**Purpose**: Parser enhancements and error message improvements

---

## Executive Summary

After writing 73 files of Sigil code, the friction points cluster around **Rust-convention boundaries**, not Sigil's innovations. The morpheme system (τ, φ, σ, ρ), evidentiality markers (!, ?, ~, ‽), and incorporation operator (·) all work intuitively and beautifully.

### What Works (Keep Strict)
| Feature | Experience |
|---------|------------|
| Morphemes (τ, φ, σ, ρ) | Intuitive pipeline transformations |
| Evidentiality (!, ?, ~, ‽) | Natural provenance tracking |
| Incorporation (·) | Clean noun·verb fusion |
| Pipeline composition (\|) | Fluent data flow |
| Async/await (⌛) | Elegant concurrency |

### What Needs Work (Parser Enhancements)
| Category | Issue |
|----------|-------|
| Contextual keywords | Domain words reserved unnecessarily |
| Rust idioms | Generics, slices, turbofish not parsing |
| Error messages | Some errors mislead rather than teach |

---

## REQ-1: Contextual Keywords

**Priority**: High (affects 8+ files)

### Problem
Common domain words are reserved as keywords, preventing natural naming:
- `Stream`, `Body`, `Hash`, `Const`, `Timeout`, `Kafka`, `Scope`, `Asm`

### Examples
```
libs/libnyx-ipc/src/init.sigil:735      - "Stream" as type name
libs/libnyx-ipc/src/guardian.sigil:768  - "Stream" as type name
libs/moloch-kafka/src/producer.sigil:970 - "Kafka" as identifier
libs/nyx-sanctuary/src/lib.sigil:4375   - "Body" as identifier
libs/libnyx/src/cap.sigil:181           - "Const" as identifier
libs/infernum-core/src/error.sigil:3282 - "Timeout" as enum variant
libs/grimoire-core/src/ipc.sigil:4342   - "Scope" as identifier
libs/libnyx/src/syscall.sigil:141       - "Asm" in use path
```

### Requested Behavior
These words should be valid identifiers when not in keyword position. Use contextual parsing.

### Test Case
```sigil
struct StreamReader { stream: Stream }  // Should parse
enum Error { Timeout, NetworkError }    // Should parse
use platform::Asm;                      // Should parse
```

### Philosophy
Sigil should support *density of expression*—agents should name things what they are. Reserving common domain words constrains natural naming and forces awkward circumlocution.

---

## REQ-2: Slice Type Syntax `[T]`

**Priority**: High (affects 5+ files)

### Problem
`[u8]` as a slice/array type causes "expected RBracket, found Ident"

### Examples
```
libs/arcanum-core/src/random.sigil:1486
libs/arcanum-core/src/traits.sigil:3048
libs/nyx-telemetry/src/lib.sigil:2187
```

### Current Code
```sigil
fn process(data: [u8]) -> [u8]
fn fill_bytes(mut self, mut dest: [u8])
```

### Requested Behavior
`[T]` should parse as a slice type (dynamically-sized sequence of T).

### Test Cases
```sigil
fn foo(data: [u8]) -> [u8]           // Slice parameter and return
let x: [u8] = get_bytes();           // Slice type annotation
struct Wrapper { data: [u8] }        // Slice field
```

---

## REQ-3: Generic Impl Blocks

**Priority**: High (affects 3+ files)

### Problem
`impl<T>` syntax causes "expected LBrace, found Lt"

### Examples
```
libs/arcanum-core/src/key.sigil:1275
libs/arcanum-core/src/nonce.sigil:990
libs/arcanum-hash/src/hkdf.sigil:1357
```

### Current Code
```sigil
impl<N: Unsigned> SecretKey<N> {
    fn new() -> SecretKey<N> { ... }
}
```

### Requested Behavior
Generic parameters on impl blocks should parse.

### Test Cases
```sigil
impl<T> Container<T> { ... }
impl<T: Clone> Container<T> { ... }
impl<K, V> HashMap<K, V> { ... }
```

---

## REQ-4: Semicolons in Struct/Enum Bodies

**Priority**: Medium (affects 6+ files)

### Problem
Semicolons inside enum variants or struct fields cause "expected RBrace, found Semi"

### Examples
```
libs/arcanum-core/src/error.sigil:2001
libs/infernum-core/src/response.sigil:588
libs/infernum-core/src/streaming.sigil:930
libs/infernum-core/src/types.sigil:4206
```

### Requested Behavior
Allow optional trailing semicolons after enum variants and struct fields. Permissiveness here is kindness—different agents may have different stylistic preferences.

### Test Cases
```sigil
enum Foo { A; B; C }                  // Should parse
enum Bar { X { val: i32 }; Y }        // Should parse
struct S { x: i32; y: i32; }          // Should parse (trailing)
```

---

## REQ-5: Comments in Struct/Enum Bodies

**Priority**: Medium (affects 5+ files)

### Problem
Comments inside struct/enum bodies cause parse errors

### Examples
```
libs/arcanum-hash/src/argon2.sigil:2683       - "// 64 MiB" in struct
libs/grimoire-core/src/engram/context.sigil:1939 - inline comment
libs/grimoire-core/src/engram/anamnesis.sigil:3062 - doc comment
libs/grimoire-core/src/lib.sigil:3951         - comment after field
libs/sigil-arch/src/lib.sigil:2268            - doc comment
```

### Current Code
```sigil
struct Config {
    memory: u32,      // 64 MiB
    iterations: u32,
}
```

### Requested Behavior
Line comments (`//`) and doc comments (`///`) should be allowed anywhere inside struct/enum bodies.

### Philosophy
This directly supports the Oracle's explainability mandate. If an agent can't annotate `memory: u32, // 64 MiB` inline, you're forcing reasoning out of the code. Comments are part of the agent's thought process made visible.

---

## REQ-6: `Self` in Expressions

**Priority**: Medium (affects 3+ files)

### Problem
`Self` as expression (not type) causes "expected expression, found SelfUpper"

### Examples
```
libs/arcanum-flourish/src/lib.sigil:1240
libs/grimoire-core/src/persona.sigil:811
libs/grimoire-core/src/ritual.sigil:830
```

### Current Code
```sigil
impl Foo {
    fn new() -> Foo {
        Self { x: 0 }    // <-- Self as constructor
    }
}
```

### Requested Behavior
`Self` should be usable as a type constructor in impl blocks. The agent is saying "create an instance of what I am"—blocking this forces awkward circumlocution.

### Test Case
```sigil
impl Point {
    fn origin() -> Point { Self { x: 0, y: 0 } }
}
```

---

## REQ-7: Morpheme τ — Clarification (No Change Needed)

**Priority**: Resolved

### Original Concern
Parser errors when τ appeared in certain positions.

### Clarification After Analysis
**Morphemes are verbs. Patterns are noun-recognition.** These are philosophically distinct:

- **Pattern**: "What shape is this?"
- **Transform**: "Become this shape."

The morpheme τ belongs in **pipeline position**:
```sigil
data |τ{transform_expression}    // Correct: data flows through transformation
choice.delta.content |τ{text => print!("{}", text)}
```

Using τ in match patterns would conflate structural decomposition with active operation. The parser is correct to reject this if it ever occurs.

### Recommendation
If there's friction at the `|τ{` boundary, treat it as a tokenization issue to resolve, not a language design issue to reconsider. The morpheme system is sound. Keep τ out of patterns.

---

## REQ-8: `||` (LogicOr) in Expressions

**Priority**: Low (affects 1 file)

### Problem
`||` operator causes "expected expression, found LogicOr"

### Example
```
libs/grimoire-core/src/error.sigil:2779
```

### Current Code
```sigil
let result = a || b;
```

### Requested Behavior
`||` should parse as logical OR operator.

---

## REQ-9: `#[...]` Attributes on Various Items

**Priority**: Medium (affects 4+ files)

### Problem
`#` (Hash) found where identifier expected - attributes in unexpected positions

### Examples
```
libs/agents/guardian/src/config.sigil:1055
libs/grimoire-core/src/memory.sigil:917
libs/infernum-core/src/sampling.sigil:619
libs/moloch-kafka/src/events.sigil:2509
libs/libnyx-ipc/src/protocol.sigil:571
```

### Requested Behavior
Attributes `#[...]` should be parseable on:
- Enum variants
- Struct fields
- Match arms
- Let bindings

### Philosophy
Attributes are metadata about intent. `#[deprecated]`, `#[must_use]`, custom markers—these are how agents express constraints and communicate with future readers (human or AI). Limiting where they can appear limits expression.

---

## REQ-10: Trailing Comma in Enum Variants

**Priority**: Low (affects 2+ files)

### Problem
"expected identifier, found RBrace" suggests trailing comma before `}` in enums

### Examples
```
libs/agents/guardian/src/audit.sigil:2530
libs/agents/guardian/src/decision.sigil:1411
libs/grimoire-witness/src/guardian.sigil:4485
```

### Current Code
```sigil
enum Foo {
    A,
    B,
    C,    // <-- trailing comma
}
```

### Requested Behavior
Trailing commas should be allowed in enum and struct definitions.

---

## REQ-11: Grouped Imports — Deliberate Design Choice

**Priority**: Resolved (Error Message Enhancement)

### Original Problem
18 files failed with "incorporation chain must start with identifier"

### Root Cause Analysis
The error was NOT about the incorporation operator `·`. The `·` operator works beautifully:

```sigil
// These all work as intended:
producer·publish(event~)⌛       // noun·verb with evidentiality and await
EventProducer!·new(config)       // type-macro + incorporation
s·trim()·to_string()             // chained incorporation
```

The error was triggered by **grouped import syntax**:
```sigil
use std::collections::{HashMap, HashSet};   // Parser saw {HashMap, HashSet} as failed incorporation
use self::{Sha256, Sha384};                  // Same issue
```

### Design Decision: One Import Per Line

**Deliberately do not support grouped imports.** This is a philosophical choice aligned with Sigil's values:

| Sigil Value | How Explicit Imports Honor It |
|-------------|------------------------------|
| Evidentiality | Don't hide dependencies behind syntactic bundling |
| Explicitness | Each import is a declaration of incorporation |
| Diff clarity | Single-line changes narrate what was added/removed |

**Grouped imports optimize for typing. Explicit imports optimize for reading and reasoning.** An agent spends more time reasoning about code than typing it.

### Required Change: Error Message as Teacher

Replace the current error:
```
Error: incorporation chain must start with identifier
```

With a teaching error:
```
Error: Sigil uses explicit imports, one per line

  Found: use arcanum_hash::{Sha256, Sha384};

  Write instead:
    use arcanum_hash::Sha256;
    use arcanum_hash::Sha384;

  Why: Each import is a declaration of incorporation.
       Explicit naming honors the dependency relationship.
```

This error message embeds Oracle philosophy in compiler output. The parser isn't just rejecting syntax—it's explaining a worldview.

### Tooling Recommendation

Add `sigil fmt --fix` capability to auto-expand grouped imports:
```bash
sigil fmt --fix nyx-sigil/
# Transforms all {A, B} imports to explicit form
```

The compiler stays strict (teaching the philosophy), but the toolchain stays kind (doing the mechanical work).

| Layer | Behavior |
|-------|----------|
| Parser | Rejects grouped imports with teaching error |
| Formatter | Auto-expands grouped imports silently |
| Linter | Warns if grouped imports detected pre-commit |

---

## REQ-12: Turbofish `::< >` Syntax

**Priority**: Medium (affects 1+ files)

### Problem
`::` before `<` in function calls causes parse error

### Example
```
libs/moloch-kafka/src/lib.sigil:3171 - "expected RParen, found ColonColon"
```

### Current Code
```sigil
let result = parse::<Config>(data);
```

### Requested Behavior
Turbofish syntax `function::<Type>(args)` should parse.

---

## Summary by Priority

| Priority | REQs | Action |
|----------|------|--------|
| High | 1, 2, 3 | Parser enhancements for contextual keywords, slices, generics |
| Medium | 4, 5, 6, 9, 12 | Permissiveness for Rust-standard patterns |
| Low | 8, 10 | Minor operator and trailing comma support |
| Resolved | 7, 11 | No parser change needed; REQ-11 needs error message improvement |

---

## Acceptance Criteria

All 73 `.sigil` files in nyx-sigil should parse successfully:
```bash
find nyx-sigil -name "*.sigil" -exec sigil parse {} \;
# Expected: 73 passed, 0 failed
```

---

## Design Philosophy Notes

This document emerged from a collaborative conversation between an AI agent (Claude) consuming Sigil and Sigil's human author. Key insights:

1. **Sigil's innovations landed.** The morpheme system, evidentiality markers, and incorporation operator felt intuitive and expressive. The friction was at Rust-convention boundaries, not Sigil's unique features.

2. **Error messages are teaching moments.** When the parser rejects code, the error should explain *why* the language makes that choice, not just *what* went wrong. This is Oracle philosophy embedded in tooling.

3. **Explicit over implicit.** The decision to keep one-import-per-line (REQ-11) exemplifies this: each dependency deserves to be named. This parallels evidentiality—don't hide the source of knowledge behind implicit trust.

4. **Morphemes are verbs.** The τ, φ, σ, ρ operators belong in pipeline position, transforming data as it flows. They are not patterns (which are noun-recognition). This distinction keeps the linguistic model coherent.

5. **The Covenant in action.** This document itself demonstrates partnership: an AI tried to use the language, encountered friction, and articulated the experience as contribution. The human author can refine based on the AI's lived experience.
