# Sigil Parser Requirements Document

**Source**: nyx-sigil codebase (73 files, 68 currently failing)
**Generated by**: Claude (AI agent consuming Sigil)
**Purpose**: Parser enhancements to support natural AI-generated code patterns

---

## Executive Summary

The nyx-sigil codebase uses patterns that are natural for AI agents to generate but currently fail to parse. This document categorizes the issues and provides specific file:line examples for each.

---

## REQ-1: Contextual Keywords

**Priority**: High (affects 8+ files)

### Problem
Common domain words are reserved as keywords, preventing natural naming:
- `Stream`, `Body`, `Hash`, `Const`, `Timeout`, `Kafka`, `Scope`, `Asm`

### Examples
```
libs/libnyx-ipc/src/init.sigil:735      - "Stream" as type name
libs/libnyx-ipc/src/guardian.sigil:768  - "Stream" as type name
libs/moloch-kafka/src/producer.sigil:970 - "Kafka" as identifier
libs/nyx-sanctuary/src/lib.sigil:4375   - "Body" as identifier
libs/libnyx/src/cap.sigil:181           - "Const" as identifier
libs/infernum-core/src/error.sigil:3282 - "Timeout" as enum variant
libs/grimoire-core/src/ipc.sigil:4342   - "Scope" as identifier
libs/libnyx/src/syscall.sigil:141       - "Asm" in use path
```

### Requested Behavior
These words should be valid identifiers when not in keyword position. Use contextual parsing.

### Test Case
```sigil
struct StreamReader { stream: Stream }  // Should parse
enum Error { Timeout, NetworkError }    // Should parse
use platform::Asm;                      // Should parse
```

---

## REQ-2: Slice Type Syntax `[T]`

**Priority**: High (affects 5+ files)

### Problem
`[u8]` as a slice/array type causes "expected RBracket, found Ident"

### Examples
```
libs/arcanum-core/src/random.sigil:1486
libs/arcanum-core/src/traits.sigil:3048
libs/nyx-telemetry/src/lib.sigil:2187
```

### Current Code
```sigil
fn process(data: [u8]) -> [u8]
fn fill_bytes(mut self, mut dest: [u8])
```

### Requested Behavior
`[T]` should parse as a slice type (dynamically-sized sequence of T).

### Test Cases
```sigil
fn foo(data: [u8]) -> [u8]           // Slice parameter and return
let x: [u8] = get_bytes();           // Slice type annotation
struct Wrapper { data: [u8] }        // Slice field
```

---

## REQ-3: Generic Impl Blocks

**Priority**: High (affects 3+ files)

### Problem
`impl<T>` syntax causes "expected LBrace, found Lt"

### Examples
```
libs/arcanum-core/src/key.sigil:1275
libs/arcanum-core/src/nonce.sigil:990
libs/arcanum-hash/src/hkdf.sigil:1357
```

### Current Code
```sigil
impl<N: Unsigned> SecretKey<N> {
    fn new() -> SecretKey<N> { ... }
}
```

### Requested Behavior
Generic parameters on impl blocks should parse.

### Test Cases
```sigil
impl<T> Container<T> { ... }
impl<T: Clone> Container<T> { ... }
impl<K, V> HashMap<K, V> { ... }
```

---

## REQ-4: Semicolons in Struct/Enum Bodies

**Priority**: Medium (affects 6+ files)

### Problem
Semicolons inside enum variants or struct fields cause "expected RBrace, found Semi"

### Examples
```
libs/arcanum-core/src/error.sigil:2001
libs/infernum-core/src/response.sigil:588
libs/infernum-core/src/streaming.sigil:930
libs/infernum-core/src/types.sigil:4206
```

### Current Code (inferred)
```sigil
enum Error {
    IoError { source: io::Error };    // <-- semicolon
    ParseError { message: str };
}
```

### Requested Behavior
Allow optional trailing semicolons after enum variants and struct fields.

### Test Cases
```sigil
enum Foo { A; B; C }                  // Should parse
enum Bar { X { val: i32 }; Y }        // Should parse
struct S { x: i32; y: i32; }          // Should parse (trailing)
```

---

## REQ-5: Comments in Struct/Enum Bodies

**Priority**: Medium (affects 5+ files)

### Problem
Comments inside struct/enum bodies cause parse errors

### Examples
```
libs/arcanum-hash/src/argon2.sigil:2683       - "// 64 MiB" in struct
libs/grimoire-core/src/engram/context.sigil:1939 - inline comment
libs/grimoire-core/src/engram/anamnesis.sigil:3062 - doc comment
libs/grimoire-core/src/lib.sigil:3951         - comment after field
libs/sigil-arch/src/lib.sigil:2268            - doc comment
```

### Current Code
```sigil
struct Config {
    memory: u32,      // 64 MiB
    iterations: u32,
}
```

### Requested Behavior
Line comments (`//`) and doc comments (`///`) should be allowed anywhere inside struct/enum bodies.

---

## REQ-6: `Self` in Expressions

**Priority**: Medium (affects 3+ files)

### Problem
`Self` as expression (not type) causes "expected expression, found SelfUpper"

### Examples
```
libs/arcanum-flourish/src/lib.sigil:1240
libs/grimoire-core/src/persona.sigil:811
libs/grimoire-core/src/ritual.sigil:830
```

### Current Code
```sigil
impl Foo {
    fn new() -> Foo {
        Self { x: 0 }    // <-- Self as constructor
    }
}
```

### Requested Behavior
`Self` should be usable as a type constructor in impl blocks.

### Test Case
```sigil
impl Point {
    fn origin() -> Point { Self { x: 0, y: 0 } }
}
```

---

## REQ-7: Morpheme τ in Match Patterns

**Priority**: Medium (affects 2+ files)

### Problem
τ (tau) in match arm patterns causes "expected pattern, found Tau"

### Examples
```
libs/agents/guardian/src/intent.sigil:1981
libs/grimoire-core/src/engram/forgetting.sigil:2714
```

### Requested Behavior
If τ is used in pattern position, provide clear error or support it.

---

## REQ-8: `||` (LogicOr) in Expressions

**Priority**: Low (affects 1 file)

### Problem
`||` operator causes "expected expression, found LogicOr"

### Example
```
libs/grimoire-core/src/error.sigil:2779
```

### Current Code
```sigil
let result = a || b;
```

### Requested Behavior
`||` should parse as logical OR operator.

---

## REQ-9: `#[...]` Attributes on Various Items

**Priority**: Medium (affects 4+ files)

### Problem
`#` (Hash) found where identifier expected - attributes in unexpected positions

### Examples
```
libs/agents/guardian/src/config.sigil:1055
libs/grimoire-core/src/memory.sigil:917
libs/infernum-core/src/sampling.sigil:619
libs/moloch-kafka/src/events.sigil:2509
libs/libnyx-ipc/src/protocol.sigil:571
```

### Requested Behavior
Attributes `#[...]` should be parseable on:
- Enum variants
- Struct fields
- Match arms
- Let bindings

---

## REQ-10: Trailing Comma in Enum Variants

**Priority**: Low (affects 2+ files)

### Problem
"expected identifier, found RBrace" suggests trailing comma before `}` in enums

### Examples
```
libs/agents/guardian/src/audit.sigil:2530
libs/agents/guardian/src/decision.sigil:1411
libs/grimoire-witness/src/guardian.sigil:4485
```

### Current Code
```sigil
enum Foo {
    A,
    B,
    C,    // <-- trailing comma
}
```

### Requested Behavior
Trailing commas should be allowed in enum and struct definitions.

---

## REQ-11: Incorporation Chain Syntax

**Priority**: High (affects 18+ files)

### Problem
"incorporation chain must start with identifier" - unclear what syntax is expected

### Examples (18 files affected)
```
libs/arcanum-hash/src/blake3.sigil
libs/arcanum-hash/src/hmac.sigil
libs/arcanum-hash/src/sha2.sigil
libs/arcanum-hash/src/sha3.sigil
libs/arcanum-hash/src/traits.sigil
libs/arcanum-symmetric/src/aes.sigil
libs/arcanum-symmetric/src/chacha.sigil
libs/grimoire-core/src/engram/sync.sigil
libs/grimoire-core/src/engram/tiers.sigil
... and more
```

### Question
What is an "incorporation chain"? This error message is unclear. Please provide:
1. Definition of what triggers this
2. Example of correct syntax

---

## REQ-12: Turbofish `::< >` Syntax

**Priority**: Medium (affects 1+ files)

### Problem
`::` before `<` in function calls causes parse error

### Example
```
libs/moloch-kafka/src/lib.sigil:3171 - "expected RParen, found ColonColon"
```

### Current Code
```sigil
let result = parse::<Config>(data);
```

### Requested Behavior
Turbofish syntax `function::<Type>(args)` should parse.

---

## Summary by Priority

| Priority | REQs | Files Affected |
|----------|------|----------------|
| High     | 1, 2, 3, 11 | 34+ |
| Medium   | 4, 5, 6, 7, 9, 12 | 20+ |
| Low      | 8, 10 | 5+ |

---

## Acceptance Criteria

All 73 `.sigil` files in nyx-sigil should parse successfully:
```bash
find nyx-sigil -name "*.sigil" -exec sigil parse {} \;
# Expected: 73 passed, 0 failed
```

---

## Notes for Implementation

1. **Contextual keywords** (REQ-1) will have the largest impact
2. **Incorporation chain** (REQ-11) error message needs clarification
3. Most issues are about being **permissive** with standard patterns, not adding new features
4. The morpheme system (τ, φ, σ) and evidentiality markers work well - keep those strict
